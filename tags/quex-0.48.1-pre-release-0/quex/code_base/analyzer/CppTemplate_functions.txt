#include <quex/code_base/temporary_macros_on>

QUEX_NAMESPACE_MAIN_OPEN

TEMPLATE_IN(InputHandleT) void
QUEX_FUNC(constructor_core)(QUEX_TYPE_ANALYZER*    me,
                            InputHandleT*          input_handle, 
                            const char*            CharacterEncodingName,
                            bool                   ByteOrderReversionF,
                            QUEX_TYPE_CHARACTER*   BufferMemory,    
                            size_t                 BufferMemorySize)
{
$$CONSTRUCTOR_MODE_DB_INITIALIZATION_CODE$$

    QUEX_NAME(AnalyzerData_construct)((QUEX_NAME(AnalyzerData)*)me,
                                      input_handle,
                                      BufferMemory, QUEX_SETTING_BUFFER_SIZE,
                                      CharacterEncodingName, 
                                      QUEX_SETTING_TRANSLATION_BUFFER_SIZE,
                                      ByteOrderReversionF);

    me->__current_mode_p = 0x0; /* REQUIRED, for mode transition check */
    QUEX_FUNC(set_mode_brutally_by_id)(me, __QUEX_SETTING_INITIAL_LEXER_MODE_ID);

#define self  (*(QUEX_TYPE_DERIVED_ANALYZER*)me)
/* START: User's constructor extensions _______________________________________*/
$$CONSTRUCTOR_EXTENSTION$$
/* END: _______________________________________________________________________*/
#undef self
}


#ifdef QUEX_OPTION_INCLUDE_STACK

TEMPLATE_IN(InputHandleT) QUEX_NAME(Memento)*
QUEX_FUNC(memento_pack)(QUEX_TYPE_ANALYZER*   me, 
                        QUEX_TYPE_CHARACTER*  InputName, 
                        InputHandleT**        input_handle)
{
#   define self  (*me)
    QUEX_NAME(Memento)* memento = QUEX_NAME(MemoryManager_Memento_allocate)();

#   ifndef __QUEX_SETTING_PLAIN_C
    /* Use placement 'new' for explicit call of constructor. 
     * Necessary in C++: Trigger call to constructor for user defined members.   */
    new ((void*)memento) QUEX_NAME(Memento);
#   endif

    memento->base._parent_memento                  = self._parent_memento;
    memento->base.buffer                           = self.buffer;
    memento->base.__current_mode_p                 = self.__current_mode_p; 
    memento->base.current_analyzer_function        = self.current_analyzer_function;
#   if    defined(QUEX_OPTION_AUTOMATIC_ANALYSIS_CONTINUATION_ON_MODE_CHANGE) \
       || defined(QUEX_OPTION_ASSERTS)
    memento->base.DEBUG_analyzer_function_at_entry = self.DEBUG_analyzer_function_at_entry;
#   endif
    memento->base.counter                          = self.counter;
#   ifdef QUEX_OPTION_STRING_ACCUMULATOR
    memento->base.accumulator                      = self.accumulator;
#   endif
    memento->base.__file_handle_allocated_by_constructor = self.__file_handle_allocated_by_constructor;

    /* Deriberately not subject to include handling:
     *    -- Mode stack.
     *    -- Token and token queues.
     *    -- Post categorizer.                                                 */

#   ifdef __QUEX_OPTION_TOKEN_POLICY_IS_QUEUE_BASED
    // QuexTokenQueueRemainder_restore(&memento->token_queue_remainder, &self._token_queue);
#   endif

/* START: User's memento 'pack' _______________________________________________*/
$$MEMENTO_EXTENSIONS_PACK$$
/* END: _______________________________________________________________________*/

    return memento;
#   undef self
}

QUEX_INLINE void
QUEX_FUNC(memento_unpack)(QUEX_TYPE_ANALYZER*  me, 
                          QUEX_NAME(Memento)*  memento)
{
#   define self  (*me)
    self._parent_memento                  = memento->base._parent_memento;
    self.buffer                           = memento->base.buffer;
    self.__current_mode_p                 = memento->base.__current_mode_p; 
    self.current_analyzer_function        = memento->base.current_analyzer_function;
#   if    defined(QUEX_OPTION_AUTOMATIC_ANALYSIS_CONTINUATION_ON_MODE_CHANGE) \
       || defined(QUEX_OPTION_ASSERTS)
    self.DEBUG_analyzer_function_at_entry = memento->base.DEBUG_analyzer_function_at_entry;
#   endif
    self.counter                          = memento->base.counter;
#   ifdef QUEX_OPTION_STRING_ACCUMULATOR
    self.accumulator                      = memento->base.accumulator;
#   endif
    self.__file_handle_allocated_by_constructor = memento->base.__file_handle_allocated_by_constructor;

#   ifdef __QUEX_OPTION_TOKEN_POLICY_IS_QUEUE_BASED
    // QuexTokenQueueRemainder_restore(&memento->token_queue_remainder, &self._token_queue);
#   endif

/* START: User's memento 'unpack' _____________________________________________*/
$$MEMENTO_EXTENSIONS_UNPACK$$
/* END: _______________________________________________________________________*/
    
#   ifndef __QUEX_SETTING_PLAIN_C
    /* Counterpart to placement new: Explicit destructor call.
     * Necessary in C++: Trigger call to destructor for user defined members.  */
    memento->~QUEX_NAME(Memento_tag)();
#   endif

    QUEX_NAME(MemoryManager_Memento_free)(memento);
#   undef self
}
#endif /* QUEX_OPTION_INCLUDE_STACK */

QUEX_NAMESPACE_MAIN_CLOSE

#include <quex/code_base/temporary_macros_off>
