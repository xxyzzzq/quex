.. _sec-engine-codec:

Analyzer Engine Codec
=====================

Apapting the internal codec of the generated lexical analyzer engine happens by
means of the command line flag ``--codec``. When a codec is specified the
internal engine will no longer run on unicode, but rather on the specified
codec. Consider the example of a lexical analyzer definition for some greek
text to be encoded in ISO-8859-7:

.. code-block:: cpp

    define {
        CAPITAL   [ΆΈΉΊΌΎ-Ϋ]   
        LOWERCASE [ά-ώ]
        NUMBER    [0-9][0-9.,]+
    }

    mode X :
    <skip: [ \t\n]>
    {
        {CAPITAL}{LOWERCASE}+  => QUEX_TKN_WORD(Lexeme);
        {NUMBER}               => QUEX_TKN_NUMBER(Lexeme);
        km2|"%"|{LOWERCASE}+   => QUEX_TKN_UNIT(Lexeme);
    }

The resulting state machine in Unicode is shown in 
Figure :ref:`Unicode Engine <fig-codec-unicode>`. This engine could 
either fed by converted file content using a converting buffer filler. 
Alternatively, it can be converted so that it directly parses ISO8859-7
encoded characters. Specifying on the command line::

   > quex (...) --codec iso8859_7 (...)

does the job. 

.. _fig-codec-unicode:

.. figure:: ../figures/state-machine-codec-unicode.*
   
   Sample lexical analyzer with an internal engine codec 'Unicode'.

The result is a converted state machine as shown in figure
:ref:`ISO8859-7 Eninge <fig-codec-iso8859-7>`. that the state machine
basically remains the same, only the transition rules have been adapted.

.. _fig-codec-iso8859-7:

.. figure:: ../figures/state-machine-codec-iso8859-7.*

   Sample lexical analyzer with an internal engine codec 'ISO8859-7' (greek).

It is worth mentioning that the command line arguments ``--codec-info`` providing
information about the list of codecs and ``--codec-for-language`` are usefule
for making decisions about what codec to choose. 

Converter Functions
===================

When the command line option ``--codec`` is used, quex automatically generates
a set of converters that may be used to convert strings of the given codec to
unicode characters. The converters are located in a header file named::

   MyEngine-converter-MyCodec
  
where ``MyEngine`` is the engine name as passed via command line option ``-o``
and ``MyCodec`` is the name of the codec as passed via command line option
``--codec``. 

The following functions allow to convert a single character from the specified
coding to UTF8, UTF16, UCS2, and UCS4:

.. code-block:: cpp

    QUEX_INLINE uint8_t*
    Quex_MyCodec_to_utf8(QUEX_TYPE_CHARACTER input, uint8_t* output);

    QUEX_INLINE uint32_t
    Quex_MyCodec_to_ucs4(QUEX_TYPE_CHARACTER input);

    QUEX_INLINE uint16_t*
    Quex_MyCodec_to_utf16(QUEX_TYPE_CHARACTER input, uint16_t* p);

    QUEX_INLINE uint16_t
    Quex_MyCodec_to_ucs2(QUEX_TYPE_CHARACTER input);

The first two functions return the incremented output pointer. This is so, since
the number of generated bytes depend on the given ``input`` character code. Using
the returned value repeatedly allows to fill a buffer step by step. The last
two functions provide character codes of fixed size encodings. Thus they simply
communicate the converter character code via the return value. A whole string
can be converted via the following functions:

.. code-block:: cpp

    QUEX_INLINE uint8_t*
    Quex_MyCodec_to_utf8_string(QUEX_TYPE_CHARACTER* Source, 
                                  size_t SourceSize, uint8_t *Drain, size_t DrainSize);

    QUEX_INLINE uint16_t*
    Quex_MyCodec_to_utf16_string(QUEX_TYPE_CHARACTER* Source, size_t SourceSize, 
                                   uint16_t *Drain, size_t DrainSize);

    QUEX_INLINE uint16_t*
    Quex_MyCodec_to_ucs2_string(QUEX_TYPE_CHARACTER* Source, size_t SourceSize, 
                                  uint16_t *Drain, size_t DrainSize);

    QUEX_INLINE uint32_t*
    Quex_MyCodec_to_ucs4_string(QUEX_TYPE_CHARACTER* Source, size_t SourceSize, 
                                  uint32_t *Drain, size_t DrainSize);


The functions are designed for streaming. They return the end of the filled drain 
region, so that it can be used for the next call to the converter. Standard C++
library strings can be converted using the following function set.

.. code-block:: cpp

    QUEX_INLINE std::string
    Quex_MyCodec_to_utf8_string(const std::basic_string<QUEX_TYPE_CHARACTER>& Source);

    QUEX_INLINE std::basic_string<uint16_t>
    Quex_MyCodec_to_utf16_string(const std::basic_string<QUEX_TYPE_CHARACTER>& Source);

    QUEX_INLINE std::basic_string<uint16_t>
    Quex_MyCodec_to_ucs2_string(const std::basic_string<QUEX_TYPE_CHARACTER>& Source);

    QUEX_INLINE std::basic_string<uint32_t>
    Quex_MyCodec_to_ucs4_string(const std::basic_string<QUEX_TYPE_CHARACTER>& Source);
